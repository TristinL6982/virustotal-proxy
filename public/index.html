<!DOCTYPE html>
<script>
  function switchTab(tabId, btn) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('button.tab').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    btn.classList.add('active');
  }

  async function scanWithProxy(url) {
    const res = await fetch('/api/virustotal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });
    return await res.json();
  }

  async function scanWithAbuseIPDB(domain) {
    const res = await fetch('/api/abuseipdb', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ip: domain })
    });
    return await res.json();
  }

  function buildVirusTotalSection(url, data) {
    const results = data.data.attributes.results;
    let malicious = 0, suspicious = 0, vendors = [];
    for (const engine in results) {
      const category = results[engine].category;
      if (category === 'malicious') malicious++;
      if (category === 'suspicious') suspicious++;
      vendors.push({ engine, category });
    }
    const totalEngines = Object.keys(results).length;
    const threats = malicious + suspicious;
    const safety = Math.round(((totalEngines - threats) / totalEngines) * 100);

    const className = malicious > 0 ? 'malicious' : suspicious > 0 ? 'suspicious' : 'clean';
    const vendorInfo = vendors.map(v => `<span class="vendor-${v.category}">- ${v.engine}: ${v.category}</span>`).join('<br>');
    const reportId = data.meta.url_info?.id ?? 'UNKNOWN';

    return {
      html: `
        <div class="result-block ${className}">
          <strong>VirusTotal Result for ${url}</strong><br>
          Malicious: ${malicious} | Suspicious: ${suspicious}<br>
          Safety Score: ${safety}%<br>
          <details><summary>Advanced Scan Information</summary>
            ${vendorInfo}
          </details>
          <a href="https://www.virustotal.com/gui/url/${reportId}" target="_blank">View full report</a>
        </div>
      `,
      score: safety
    };
  }

  function buildAbuseIPDBSection(ip, data) {
    const abuseScore = data.abuseConfidenceScore || 0;
    const safety = 100 - abuseScore;
    const className = abuseScore >= 50 ? 'malicious' : abuseScore > 0 ? 'suspicious' : 'clean';

    return {
      html: `
        <div class="result-block ${className}">
          <strong>AbuseIPDB Result for ${ip}</strong><br>
          Abuse Score: ${abuseScore}%<br>
          Safety Score: ${safety}%<br>
          Country: ${data.countryCode}<br>
          ISP: ${data.isp}<br>
          <details><summary>Advanced Scan Information</summary>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </details>
        </div>
      `,
      score: safety
    };
  }

  async function scanUrls() {
    const input = document.getElementById("urlInput").value;
    const urls = input.split(';').map(u => u.trim()).filter(Boolean);
    const resultDiv = document.getElementById("urlResult");
    resultDiv.innerHTML = "<div class='loading'>Scanning...</div>";
    let output = "";
    let allScores = [];

    for (const url of urls) {
      try {
        const domain = new URL(url).hostname;
        const vtData = await scanWithProxy(url);
        const ipData = await scanWithAbuseIPDB(domain);

        const vtResult = buildVirusTotalSection(url, vtData);
        const abResult = buildAbuseIPDBSection(domain, ipData);

        allScores.push(vtResult.score, abResult.score);
        output += vtResult.html + abResult.html;
      } catch (err) {
        output += `<div class="malicious">Error scanning ${url}: ${err.message}</div>`;
      }
    }

    const avgScore = allScores.length ? Math.round(allScores.reduce((a, b) => a + b) / allScores.length) : 0;
    const summary = `<h3>Combined Safety Score: ${avgScore}%</h3><hr>`;
    resultDiv.innerHTML = summary + output;
  }

  async function scanEmailText() {
    const input = document.getElementById("emailInput").value;
    const urls = input.match(/https?:\/\/[\w.-]+(?:\.[\w.-]+)+(?:[\/\w?=&#%.-]*)/g) || [];
    const resultDiv = document.getElementById("emailResult");
    resultDiv.innerHTML = urls.length ? "<div class='loading'>Scanning...</div>" : "No URLs found.";
    let output = "";
    let allScores = [];

    for (const url of urls) {
      try {
        const domain = new URL(url).hostname;
        const vtData = await scanWithProxy(url);
        const ipData = await scanWithAbuseIPDB(domain);

        const vtResult = buildVirusTotalSection(url, vtData);
        const abResult = buildAbuseIPDBSection(domain, ipData);

        allScores.push(vtResult.score, abResult.score);
        output += vtResult.html + abResult.html;
      } catch (err) {
        output += `<div class="malicious">Error scanning ${url}: ${err.message}</div>`;
      }
    }

    const avgScore = allScores.length ? Math.round(allScores.reduce((a, b) => a + b) / allScores.length) : 0;
    const summary = `<h3>Combined Safety Score: ${avgScore}%</h3><hr>`;
    resultDiv.innerHTML = summary + output;
  }
</script>
